# =============================================================================================================================
#
# Apache2.4 (CentOS7), PHP7.3
#
# =============================================================================================================================

# -----------------------------------------------------------------------------------------------------------------------------
# ベースイメージの指定
# -----------------------------------------------------------------------------------------------------------------------------
FROM centos:7

# -----------------------------------------------------------------------------------------------------------------------------
# 作成者情報
# -----------------------------------------------------------------------------------------------------------------------------
LABEL mantainer Numakunai_Shunichi

# -----------------------------------------------------------------------------------------------------------------------------
# CentOS7のインストール
# -----------------------------------------------------------------------------------------------------------------------------
RUN yum -y install epel-release
RUN rpm -ivh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm

# -----------------------------------------------------------------------------------------------------------------------------
# Linuxコマンドのインストール
# -----------------------------------------------------------------------------------------------------------------------------
RUN yum -y install wget zip unzip vim less

# -----------------------------------------------------------------------------------------------------------------------------
# PHPのインストール
# -----------------------------------------------------------------------------------------------------------------------------
RUN yum -y install -y --enablerepo=remi,remi-php73 php php-mbstring php-mcrypt php-mysql php-pdo php-pecl-xdebug php-pear json

# -----------------------------------------------------------------------------------------------------------------------------
# MySQLのインストール
# -----------------------------------------------------------------------------------------------------------------------------
RUN yum -y install https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm
RUN rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
RUN yum -y install mysql-community-server
RUN yum -y install mysql-community-client

# -----------------------------------------------------------------------------------------------------------------------------
# php.iniの置換
# -----------------------------------------------------------------------------------------------------------------------------
RUN cp /etc/php.ini /etc/php.ini.bak
COPY php.ini /etc/

# -----------------------------------------------------------------------------------------------------------------------------
# これは環境ごとのphp.iniを入れておく場所、develop.iniなど
# -----------------------------------------------------------------------------------------------------------------------------
RUN cp -r /etc/php.d /etc/php.d.bak
COPY php.d/* /etc/php.d/

# -----------------------------------------------------------------------------------------------------------------------------
# Apacheのインストール
# -----------------------------------------------------------------------------------------------------------------------------
RUN yum -y install httpd httpd-devel

# -----------------------------------------------------------------------------------------------------------------------------
# httpd.confファイルを置換
# -----------------------------------------------------------------------------------------------------------------------------
RUN cp /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.bak
COPY httpd.conf /etc/httpd/conf

# -----------------------------------------------------------------------------------------------------------------------------
# ソースディレクトリの作成
# -----------------------------------------------------------------------------------------------------------------------------
RUN mkdir -p /httpd/htdocs/passwdweb \
    && mkdir -p /httpd/htdocs_local/passwdweb \
    && mkdir -p /httpd/htdocs_noweb/passwdweb

# init.shを/bin下に配置する
COPY init.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/init.sh

# -----------------------------------------------------------------------------------------------------------------------------
# Apacheの起動
# -----------------------------------------------------------------------------------------------------------------------------
CMD ["/usr/local/bin/init.sh"]